<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0, minimum-scale=0.5">
  <title>Poker Flip App</title>
  <meta name="description" content="トランプカードをフリップして表示するミニアプリ">
  
  <!-- OGP設定（LINE転送時のプレビュー用） -->
  <meta property="og:title" content="Poker Flip App">
  <meta property="og:description" content="トランプカードをフリップして表示するポーカーアプリ">
  <meta property="og:image" content="./icons/icon-512x512.png">
  <meta property="og:image:width" content="512">
  <meta property="og:image:height" content="512">
  <meta property="og:image:type" content="image/png">
  <meta property="og:url" content="https://poker-flip-app.netlify.app/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Poker Flip App">
  <meta property="og:locale" content="ja_JP">
  
  <!-- Twitter Card設定 -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Poker Flip App">
  <meta name="twitter:description" content="トランプカードをフリップして表示するポーカーアプリ">
  <meta name="twitter:image" content="./icons/icon-512x512.png">
  
  <!-- LINE用の追加設定 -->
  <meta name="application-name" content="Poker Flip App">
  <meta name="msapplication-TileImage" content="./icons/icon-192x192.png">
  <meta name="msapplication-TileColor" content="#ff9f43">
  
  <!-- PWA設定 -->
  <meta name="theme-color" content="#ff9f43">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Poker Flip">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  
  <!-- アイコン設定 -->
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512x512.png">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <link rel="stylesheet" href="./cards.css?v=20251017-2">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ffb366 0%, #ff9f43 50%, #ff8c42 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: scroll-position;
    }
    
    /* スマホ版では完全に異なるレイアウト */
    @media (max-width: 768px) {
      body {
        display: block !important;
        align-items: stretch !important;
        justify-content: flex-start !important;
        padding: 12px !important;
        min-height: 100vh !important;
      }
      
      .container {
        margin: 0 !important;
        max-width: 100% !important;
        border-radius: 12px !important;
        padding: 16px !important;
      }
    }

    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      padding: 24px;
      width: 100%;
      max-width: 960px;
      box-sizing: border-box;
    }

    /* PC表示時: ページ全体をスクロール可能にし、中央寄せ */
    @media (min-width: 769px) {
      html {
        overflow-y: scroll !important; /* 常に縦スクロールバーを出し、レイアウト確定 */
      }
      html, body {
        height: auto !important;
        overflow-y: auto !important;
      }
      body {
        display: block !important;
        align-items: initial !important;
        justify-content: initial !important;
        min-height: auto !important;
        overflow-y: auto !important;
        transform: none !important;
        -webkit-transform: none !important;
        will-change: auto !important;
        background-attachment: scroll !important; /* 固定背景がスクロールを阻害する可能性を排除 */
        position: static !important;
      }
      .container {
        margin: 24px auto !important;
        max-height: none !important;
        overflow: visible !important;
      }
    }

    h1 {
      margin: 0 0 16px;
      text-align: center;
      color: #333;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #667eea;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    #revealBoardBtn {
      background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
      box-shadow: 0 4px 12px rgba(255,107,157,0.4);
    }

    #revealBoardBtn:hover {
      background: linear-gradient(135deg, #ff5a8a 0%, #ff7fa1 100%);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(80px, 1fr));
      gap: 12px;
      justify-items: center;
    }

    @media (max-width: 640px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }

    .copyright {
      text-align: center;
      font-size: 12px;
      color: #333;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.2);
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Poker Flip App</h1>
    
    

    <h2 style="margin:0 0 8px; text-align:center; color:#333; font-size:18px;">NLH フリップアウト</h2>
    <div class="toolbar" id="nlhToolbar">
      <label style="display:flex; align-items:center; gap:8px; font-weight:bold; color:#333;">
        プレイヤー人数
        <input id="playersCount" type="number" min="2" max="12" step="1" value="6" style="width:64px; padding:10px 12px; border-radius:10px; border:1px solid #ccc; font-size:14px;">
        <button id="playersInc" class="btn" aria-label="人数を増やす" style="padding:6px 10px; line-height:1;">▲</button>
        <button id="playersDec" class="btn" aria-label="人数を減らす" style="padding:6px 10px; line-height:1;">▼</button>
      </label>
      <button class="btn" id="startFlipoutBtn" aria-label="新しいハンドを開始">新しいハンド</button>
      <button class="btn" id="revealBoardBtn" aria-label="ボードカードを順に公開">ボードを出す</button>
      <button class="btn" id="showdownBtn" aria-label="ショーダウンして役を判定">ショーダウン（役の判定）</button>
    </div>

    <div id="tableArea">
      <div style="display:flex; align-items:center; justify-content:center; gap:16px; width:100%;">
        <div class="board-holder">
          <div id="community" class="board-row"></div>
        </div>
      </div>
      <div id="seats" class="seats"></div>
      <div id="status" class="status"></div>
    </div>

    <!-- コピーライト -->
    <div class="copyright">
      © 2025 D.D🐏. All rights reserved.
    </div>
    
    <!-- フィードバック（不具合/コメント）簡易フォーム -->
    <div class="feedback-footer" aria-label="フィードバックフォーム">
      <form name="feedback" method="POST" data-netlify="true" action="/thanks.html">
        <input type="hidden" name="form-name" value="feedback">
        <label class="sr-only" for="fb-message">不具合やご意見</label>
        <textarea id="fb-message" name="message" rows="2" maxlength="500" placeholder="不具合やアプリの感想があればどうぞ（任意）"></textarea>
        <div class="feedback-row">
          <input type="email" name="email" placeholder="返信先メール（任意）">
          <button type="submit" class="btn" aria-label="フィードバックを送信">送信</button>
        </div>
      </form>
      <div class="version-info">v2.0.0</div>
    </div>
    
  </div>

  <script type="module" src="./cards.js?v=20251017-2"></script>
  
  <!-- Service Worker登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
    
    // PWAインストール促進
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('PWAインストール可能');
      e.preventDefault();
      deferredPrompt = e;
      
      // インストールボタンを表示
      const installBtn = document.createElement('button');
      installBtn.textContent = '📱 アプリをインストール';
      installBtn.className = 'btn';
      installBtn.style.margin = '8px';
      installBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
      installBtn.style.boxShadow = '0 4px 12px rgba(34,197,94,0.4)';
      
      installBtn.setAttribute('aria-label', 'このアプリをホーム画面にインストール');

      installBtn.addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('PWAインストール承認');
            } else {
              console.log('PWAインストール拒否');
            }
            deferredPrompt = null;
            installBtn.remove();
          });
        }
      });
      
      // ツールバーに追加
      const toolbar = document.querySelector('.toolbar');
      if (toolbar) {
        toolbar.appendChild(installBtn);
      }
    });
    
    // インストール完了の検知
    window.addEventListener('appinstalled', (evt) => {
      console.log('PWAがインストールされました');
    });
  </script>
  
  <!-- PWAオフライン時のキャッシュ自動クリア＆SW解除（ホーム画面起動時のみ） -->
  <script>
    (function setupOfflineAutoClear() {
      const isStandalone = () => (
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true
      );
      async function clearCachesAndUnregister() {
        try {
          if (window.caches) {
            const names = await caches.keys();
            await Promise.all(names.map((n) => caches.delete(n)));
          }
        } catch (e) {
          console.log('Cache clear failed', e);
        }
        try {
          if (navigator.serviceWorker) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map((r) => r.unregister()));
          }
        } catch (e) {
          console.log('SW unregister failed', e);
        }
      }
      window.addEventListener('offline', async () => {
        if (!isStandalone()) return;
        console.log('Offline detected in standalone - clearing caches and unregistering SW');
        await clearCachesAndUnregister();
      });
    })();
  </script>
  
  <!-- 前回未解放セッション検知→次回起動時にキャッシュとSWをクリア（ホーム起動時のみ） -->
  <script>
    (function sessionClearOnNextLaunch() {
      const isStandalone = () => (
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true
      );
      const SESSION_FLAG = 'pfa_session_open';
      async function clearAll() {
        try {
          if (window.caches) {
            const names = await caches.keys();
            await Promise.all(names.map((n) => caches.delete(n)));
          }
        } catch (e) { console.log('Cache clear failed', e); }
        try {
          if (navigator.serviceWorker) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map((r) => r.unregister()));
          }
        } catch (e) { console.log('SW unregister failed', e); }
      }
      document.addEventListener('DOMContentLoaded', async () => {
        if (!isStandalone()) return;
        const wasOpen = localStorage.getItem(SESSION_FLAG) === '1';
        if (wasOpen) {
          console.log('Previous session not closed - clearing caches and unregistering SW');
          await clearAll();
        }
        localStorage.setItem(SESSION_FLAG, '1');
      });
      window.addEventListener('pagehide', () => {
        if (isStandalone()) localStorage.removeItem(SESSION_FLAG);
      });
      window.addEventListener('beforeunload', () => {
        if (isStandalone()) localStorage.removeItem(SESSION_FLAG);
      });
    })();
  </script>
  
  <script type="module">
    import { startNewHand, startNewHandAnimated, showdown, autoReveal } from './cards.js';

    const seats = document.getElementById('seats');
    const community = document.getElementById('community');
    const statusEl = document.getElementById('status');
    
    // スマホでのスクロール問題を強制的に解決
    function ensureMobileScroll() {
      if (window.innerWidth <= 768) {
        document.body.style.display = 'block';
        document.body.style.alignItems = 'stretch';
        document.body.style.justifyContent = 'flex-start';
        document.body.style.minHeight = '100vh';
        
        const container = document.querySelector('.container');
        if (container) {
          container.style.margin = '0';
          container.style.maxWidth = '100%';
        }
        
        // 強制的にスクロール可能にする
        document.documentElement.style.height = 'auto';
        document.body.style.height = 'auto';
        document.body.style.maxHeight = 'none';
      }
    }
    
    // PCでのスクロール問題を強制的に解決（特に初回に人数が多い場合）
    function ensureDesktopScroll() {
      if (window.innerWidth >= 769) {
        document.documentElement.style.height = 'auto';
        document.documentElement.style.overflowY = 'auto';
        document.body.style.height = 'auto';
        document.body.style.overflowY = 'auto';
        document.body.style.transform = 'none';
        document.body.style.webkitTransform = 'none';
        document.body.style.willChange = 'auto';
        document.body.style.backgroundAttachment = 'scroll';
        document.body.style.position = 'static';
      }
    }

    // ページ読み込み時とリサイズ時に実行
    ensureMobileScroll();
    ensureDesktopScroll();
    window.addEventListener('resize', ensureMobileScroll);
    window.addEventListener('resize', ensureDesktopScroll);

    // NLH Flipout controls
    const playersCountInput = document.getElementById('playersCount');
    const startFlipoutBtn = document.getElementById('startFlipoutBtn');
    const revealBoardBtn = document.getElementById('revealBoardBtn');
    const showdownBtn = document.getElementById('showdownBtn');
    const playersInc = document.getElementById('playersInc');
    const playersDec = document.getElementById('playersDec');
    

    // インストール案内を隠すユーティリティ（Androidボタン/iOSヒントの両方を対象）
    function hideInstallPrompt() {
      const btn = document.querySelector('button[aria-label="このアプリをホーム画面にインストール"]');
      if (btn) btn.remove();
      const iosHint = document.getElementById('iosInstallHint');
      if (iosHint) iosHint.remove();
    }

    // NLH Flipout events
    startFlipoutBtn.addEventListener('click', async () => {
      hideInstallPrompt();
      const n = Math.max(2, Math.min(12, parseInt(playersCountInput.value || '6', 10)));
      await startNewHandAnimated({ 
        seatsEl: seats, 
        communityEl: community, 
        statusEl, 
        numPlayers: n,
        onDone: () => {
          // 初回から人数が多い場合でもスクロール可能にする
          ensureDesktopScroll();
          // 念のため、座席エリアの最後へスクロール（長い画面で効果）
          try {
            const lastSeat = seats.lastElementChild;
            // PCでは勝手にスクロールしない。モバイル時のみ実行
            if (window.innerWidth <= 768 && lastSeat) {
              lastSeat.scrollIntoView({ behavior: 'auto', block: 'end' });
            }
          } catch (_) {}
        }
      });
    });

    // 手動のフロップ/ターン/リバーは削除（自動進行に一本化）

    showdownBtn.addEventListener('click', () => {
      hideInstallPrompt();
      showdown();
    });


    // ボードを出す: フロップ→ターン→リバーの自動公開
    revealBoardBtn.addEventListener('click', () => {
      hideInstallPrompt();
      autoReveal({ flopDelayMs: 600, turnDelayMs: 1000, riverDelayMs: 1000, autoShowdown: false });
    });

    // --- iOS Safari向け: beforeinstallpromptが無いため、トップのみヒントを表示 ---
    (function showIosInstallHintIfNeeded() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (isIOS && isSafari && !isStandalone) {
        const toolbar = document.querySelector('.toolbar');
        if (!toolbar) return;
        const hint = document.createElement('div');
        hint.id = 'iosInstallHint';
        hint.setAttribute('role', 'status');
        hint.setAttribute('aria-live', 'polite');
        hint.style.padding = '8px 12px';
        hint.style.borderRadius = '8px';
        hint.style.background = 'rgba(0,0,0,0.06)';
        hint.style.color = '#333';
        hint.style.fontSize = '12px';
        hint.style.display = 'flex';
        hint.style.alignItems = 'center';
        hint.style.gap = '8px';
        hint.style.maxWidth = '100%';
        hint.innerHTML = '📲 ホーム画面に追加するには、Safariの共有ボタンから「ホーム画面に追加」を選択してください。';
        toolbar.appendChild(hint);
      }
    })();

    // 人数の上下ボタンと入力のクランプ
    function clampPlayers(val) {
      const n = Math.max(2, Math.min(12, parseInt(val || '6', 10)));
      playersCountInput.value = String(n);
      return n;
    }
    playersInc.addEventListener('click', () => {
      clampPlayers((parseInt(playersCountInput.value || '6', 10) + 1).toString());
    });
    playersDec.addEventListener('click', () => {
      clampPlayers((parseInt(playersCountInput.value || '6', 10) - 1).toString());
    });
    playersCountInput.addEventListener('change', () => clampPlayers(playersCountInput.value));
    playersCountInput.addEventListener('blur', () => clampPlayers(playersCountInput.value));
  </script>
</body>
</html>


